var app=angular.module("App",["infinite-scroll","ngSanitize","ngRoute","ng-token-auth","ipCookie"]);app.config(function($routeProvider,$locationProvider){$locationProvider.html5Mode({enabled:!0})}),app.factory("Filters",["$location",function($location){var filters={};return{getFilters:function(){return filters},setFilter:function(name,value){filters[name]=value,$location.search(name,value)},removeFilter:function(name){delete filters[name],_.isEmpty(filters)?$location.url($location.path()):$location.search(name,null)},useQuery:function(query){filters=query,_.isEmpty(filters)?$location.url($location.path()):$location.search(filters)},resetAll:function(){filters={},$location.url($location.path())}}}]),app.factory("Categories",["$http",function($http){var categories=[];return{fetchCategories:function(){$http.get("categories.json").success(function(data){categories=data})},list:function(){return categories}}}]),app.factory("SubCategories",["$http",function($http){var subCategories=[];return{fetchSubCategories:function(){$http.get("sub_categories.json").success(function(data){subCategories=data})},list:function(){return subCategories}}}]),app.factory("Products",["$http","Filters","$location",function($http,Filters,$location){var query=$location.search();Filters.useQuery(query);var products=[],page=1,searching=!0;return{getProducts:function(){return products},currentPage:function(){return page},currentlySearching:function(){return searching},enumeratePage:function(){page+=1},resetProducts:function(){products=[]},resetPage:function(){page=1},addProducts:function(newProducts){products=products.concat(newProducts)},fetchProducts:function(){searching=!0,$http.get("products.json",{async:!0,params:{page:page.toString(),gender:Filters.getFilters().gender,category:Filters.getFilters().category,sub_category:Filters.getFilters().subCategory,search_string:Filters.getFilters().searchString}}).success(function(data){products=products.concat(data),scrollActive=!0,searching=!1})}}}]),app.controller("UserSessionsController",["$scope",function($scope){console.log("Hey from users controller"),$scope.$on("auth:login-error",function(ev,reason){$scope.error=reason.errors[0]}),$scope.$on("auth:login-success",function(){$("#signInModal").foundation("reveal","close")}),$scope.handleLoginBtnClick=function(){$auth.submitLogin($scope.loginForm).then(function(){}).catch(function(){})}}]),app.controller("UserRegistrationsController",["$scope","$auth",function($scope,$auth){$scope.$on("auth:registration-email-success",function(ev,message){$("#signUpModal").foundation("reveal","close"),console.log(message),$auth.submitLogin({email:$scope.registrationForm.email,password:$scope.registrationForm.password})}),$scope.handleRegBtnClick=function(){$auth.submitRegistration($scope.registrationForm).then(function(){}).catch(function(){})}}]),app.controller("ProductsController",["$http","Filters","Products",function($http,Filters,Products){this.scrollActive=!1;var scrollActive=this.scrollActive,productCtrl=this;productCtrl.products=Products,this.filters=Filters,$http.get("products.json",{params:{page:Products.currentPage().toString(),gender:this.filters.getFilters().gender,category:this.filters.getFilters().category,sub_category:this.filters.getFilters().subCategory,search_string:this.filters.getFilters().searchString}}).success(function(data){productCtrl.products.addProducts(data),scrollActive=!0}),this.wishFor=function(product,userId){userId?$http.post("products/"+product.id+"/wish.json",{}).success(function(){alert("wished for!")}):$("#signInModal").foundation("reveal","open")},this.openLink=function(product,userId){window.open(product.url,"_blank"),userId||$("#signUpModal").foundation("reveal","open")},this.nextPage=function(){scrollActive===!0&&(scrollActive=!1,Products.enumeratePage(),$http.get("products.json",{async:!0,params:{page:Products.currentPage().toString(),gender:this.filters.getFilters().gender,category:this.filters.getFilters().category,sub_category:Filters.getFilters().subCategory,search_string:Filters.getFilters().searchString}}).success(function(data){productCtrl.products.addProducts(data),scrollActive=!0}))}}]),app.controller("GenderController",["Filters","Products",function(Filters,Products){this.setGender=function(gender){"mens"===gender?Filters.setFilter("gender","male"):"womens"===gender?Filters.setFilter("gender","female"):""===gender&&Filters.removeFilter("gender"),Products.resetProducts(),Products.resetPage(),Products.fetchProducts()}}]),app.controller("CategoryController",["Filters","Products","Categories",function(Filters,Products,Categories){var categoryCtrl=this;categoryCtrl.categories=[],Categories.fetchCategories(),categoryCtrl.categories=Categories,this.filters=Filters,this.setCategory=function(cat_id){""===cat_id?Filters.removeFilter("category"):Filters.setFilter("category",parseInt(cat_id)),Filters.removeFilter("subCategory"),Products.resetProducts(),Products.resetPage(),Products.fetchProducts()}}]),app.controller("SubCategoryController",["Filters","Products","Categories","SubCategories",function(Filters,Products,Categories,SubCategories){var subCatCtrl=this;subCatCtrl.subCategories=[],SubCategories.fetchSubCategories(),subCatCtrl.subCategories=SubCategories,this.filters=Filters,this.setSubCat=function(sub_cat_id){""===sub_cat_id?Filters.removeFilter("subCategory"):Filters.setFilter("subCategory",parseInt(sub_cat_id)),Products.resetProducts(),Products.resetPage(),Products.fetchProducts()}}]),app.controller("SearchController",["Filters","Products","Categories",function(Filters,Products,Categories){this.updateSearch=function(searchString){null!==searchString&&void 0!==searchString&&""!==searchString&&" "!==searchString&&(Filters.setFilter("searchString",searchString),Products.resetProducts(),Products.resetPage(),Products.fetchProducts())},this.findCat=function(searchString){Filters.removeFilter("category"),Filters.removeFilter("subCategory");var words=searchString.toLowerCase().split(" ");_(words).forEach(function(word){void 0===Filters.getFilters().category&&_(Categories.list()).forEach(function(category){void 0===Filters.getFilters().category&&(category.name===word?Filters.setFilter("category",parseInt(category.id)):category.name.substring(0,category.name.length-1)===word&&Filters.setFilter("category",parseInt(category.id)))})})}}]);